<!DOCTYPE html>
<html>
<head>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap-theme.min.css">
    <title>CBOT Control</title>
</head>
<body>

<xml id="toolbox" style="display: none">
    <category name="CBOT Closures">
        <block type="cbot_closure"></block>
        <block type="cbot_forward"></block>
        <block type="cbot_backward"></block>
        <block type="cbot_turnleft"></block>
        <block type="cbot_turnright"></block>
        <block type="cbot_halt"></block>
        <block type="cbot_import"></block>
        <block type="cbot_sleep"></block>
    </category>
    <category name="Control">
        <block type="controls_if"></block>
        <block type="controls_whileUntil"></block>
    </category>
    <category name="Logic">
        <block type="logic_compare"></block>
        <block type="logic_operation"></block>
        <block type="logic_boolean"></block>
    </category>
</xml>

<div class="container-fluid">
    <div class="row">
        <div id="blocklyDiv" class="col-sm-10" style="height: 75vh"></div>
        <div id="statusWindow" class="col-sm-2" style="height: 75vh">
             <table width="100%">
                  <tr><th colspan="6">CloudBOT 1</th></tr>
                  <tr>
                      <td colspan="2">Left: <span id="ind1_left">&#9587;</span></td>
                      <td colspan="2">Center: <span id="ind1_center">&#9587;</span></td>
                      <td colspan="2">Right: <span id="ind1_right">&#9587;</span></td>
                  </tr>
                  <tr>
                      <td colspan="3">Distance: <span id="ind1_distance">0</span>cm</td>
                      <td colspan="3">Temp: <span id="ind1_temp">0</span>&deg;C</td>
                  </tr>
                  <tr><th colspan="6">CloudBOT 2</th></tr>
                  <tr>
                      <td colspan="2">Left: <span id="ind2_left">&#9587;</span></td>
                      <td colspan="2">Center: <span id="ind2_center">&#9587;</span></td>
                      <td colspan="2">Right: <span id="ind2_right">&#9587;</span></td>
                  </tr>
                  <tr>
                      <td colspan="3">Distance: <span id="ind2_distance">0</span>cm</td>
                      <td colspan="3">Temp: <span id="ind2_temp">0</span>&deg;C</td>
                  </tr>
                  <tr><th colspan="6">CloudBOT 3</th></tr>
                  <tr>
                      <td colspan="2">Left: <span id="ind3_left">&#9587;</span></td>
                      <td colspan="2">Center: <span id="ind3_center">&#9587;</span></td>
                      <td colspan="2">Right: <span id="ind3_right">&#9587;</span></td>
                  </tr>
                  <tr>
                      <td colspan="3">Distance: <span id="ind3_distance">0</span>cm</td>
                      <td colspan="3">Temp: <span id="ind3_temp">0</span>&deg;C</td>
                  </tr>
             </table>
        </div>
    </div>
    <div class="row">
        <div id="blocklyCode" class="col-sm-12" style="height: 20vh"></div>
        <input type="button" value="Submit" onclick="sendToCGIBIN()"/>
    </div>
</div>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
<script src="https://blockly-demo.appspot.com/static/blockly_compressed.js"></script>
<script src="https://blockly-demo.appspot.com/static/blocks_compressed.js"></script>
<script src="https://blockly-demo.appspot.com/static/msg/js/en.js"></script>
<script src="https://blockly-demo.appspot.com/static/python_compressed.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
<script>
    var workspace = Blockly.inject('blocklyDiv', {toolbox: document.getElementById('toolbox')});
    var xxx = undefined;

    // TODO: Debug mode. Display Source at bottom
    workspace.addChangeListener(myUpdateFunction);
    function myUpdateFunction(event) {
        var code = Blockly.Python.workspaceToCode(workspace);
        document.getElementById('blocklyCode').innerHTML = code.replace("\n", "<br/>");

        if ( event.type == Blockly.Events.DELETE && event.oldXml.getAttribute("type") == "cbot_closure"  ){
            var blockId = event.blockId;
            var closure = event.oldXml;
            var closureField = closure.getElementsByTagName("field")[0]
            var closureName = closureField.childNodes[0].textContent;
            console.log("Deleting a closure [" + closureName + "]")
            for( codeBlocks in cbotClsObj ){
                if( cbotClsObj[codeBlocks]["id"] == blockId){
                    delete cbotClsObj[codeBlocks];
                }
            }
            console.log("Finding replacements for [" + closureName + "]")
            for( idx = 0; idx < workspace.topBlocks_.length; idx++ ){
                var fieldRow = workspace.topBlocks_[idx].inputList[0].fieldRow[1]
                if ( fieldRow != undefined ){
                    if ( fieldRow.text_ == closureName ){
                        console.log("Blocks matched [" + closureName + "]")
                        cbotClsObj[closureName] = {"statement":Blockly.Python['cbot_closure'](workspace.topBlocks_[idx]), "id": workspace.topBlocks_[0].id}
                    }
                }
            }
            xxx = event;
        }
    }
    
    var cbotClsObj = {}
    //=============================
    // Block Definitions
    //=============================
    Blockly.Blocks['cbot_closure'] = {
        init: function() {
        this.appendStatementInput("cbot_closure")
            .setCheck(null)
            .appendField("CloudBOT")
            .appendField(new Blockly.FieldDropdown([['cbot1', 'cbot1'], ['cbot2', 'cbot2'], ['cbot3', 'cbot3']]), "cbot_name");
        this.setColour(45);
        this.setTooltip('');
        this.setHelpUrl('http://www.example.com/');
        }
    }; 
    Blockly.Blocks['cbot_forward'] = {
        init: function() {
        this.appendDummyInput()
            .appendField("Forward");
        this.setPreviousStatement(true);
        this.setNextStatement(true);
        this.setColour(60);
        }
    };
    Blockly.Blocks['cbot_backward'] = {
        init: function() {
        this.appendDummyInput()
            .appendField("Backward");
        this.setPreviousStatement(true);
        this.setNextStatement(true);
        this.setColour(60);
        }
    };
    Blockly.Blocks['cbot_turnleft'] = {
        init: function() {
        this.appendDummyInput()
            .appendField("Turn Left");
        this.setPreviousStatement(true);
        this.setNextStatement(true);
        this.setColour(60);
        }
    };
    Blockly.Blocks['cbot_turnright'] = {
        init: function() {
        this.appendDummyInput()
            .appendField("Turn Right");
        this.setPreviousStatement(true);
        this.setNextStatement(true);
        this.setColour(60);
        }
    };
    Blockly.Blocks['cbot_halt'] = {
        init: function() {
        this.appendDummyInput()
            .appendField("Halt");
        this.setPreviousStatement(true);
        this.setNextStatement(true);
        this.setColour(60);
        }
    };
    Blockly.Blocks['cbot_import'] = {
        init: function() {
        this.appendDummyInput()
            .appendField("import")
            .appendField(new Blockly.FieldTextInput("time"), "cbot_import");
        this.setPreviousStatement(true);
        this.setNextStatement(true);
        this.setColour(50);
        }
    };
    Blockly.Blocks['cbot_sleep'] = {
        init: function() {
        this.appendDummyInput()
            .appendField("Sleep")
            .appendField(new Blockly.FieldTextInput("0"), "cbot_sleep")
            .appendField("second(s)");
        this.setPreviousStatement(true);
        this.setNextStatement(true);
        this.setColour(50);
        }
    };
    
    //=============================
    // Code Definitions
    //=============================
    Blockly.Python['cbot_closure'] = function(block) {
        var dropdown_cbot_name = block.getFieldValue('cbot_name');
        var statements_cbot_closure = Blockly.Python.statementToCode(block, 'cbot_closure');
       
        if ( statements_cbot_closure != "" ){
            var stmt = statements_cbot_closure;

            var lines = stmt.split("\n")
            var complete = false;
            while(!complete){
                complete = true;
                for(i = 1; i < lines.length; i++){
                    if(lines[i] == lines[i-1]){
                        lines.splice(i, 1)
                        complete = false;
                    }
                }
            }
            stmt = lines.join("\n")
            console.log("Sanitized:\n" + stmt)

            stmt = stmt.trim();
            stmt = stmt.split("\n  ")
            stmt = stmt.join("\n")
            cbotClsObj[dropdown_cbot_name] = {"statement":stmt, "id":block.id};
        }
        
        return stmt;
    };
    Blockly.Python['cbot_forward'] = function(block) {
        var code = 'forward()\n';
        return code;
    };
    Blockly.Python['cbot_backward'] = function(block) {
        var code = 'backward()\n';
        return code;
    };
    Blockly.Python['cbot_turnleft'] = function(block) {
        var code = 'turnleft()\n';
        return code;
    };
    Blockly.Python['cbot_turnright'] = function(block) {
        var code = 'turnright()\n';
        return code;
    };
    Blockly.Python['cbot_halt'] = function(block) {
        var code = 'halt()\n';
        return code;
    };
    Blockly.Python['cbot_import'] = function(block) {
        var text_cbot_import = block.getFieldValue('cbot_import');
        var code = 'import ' + text_cbot_import + '\n';
        return code;
    };
    Blockly.Python['cbot_sleep'] = function(block) {
        var text_cbot_sleep = block.getFieldValue('cbot_sleep');
        var code = 'time.sleep(' + text_cbot_sleep + ')\n';
        return code;
    };
    
    //=============================
    // Client-side Functions
    //=============================
    function sendToCGIBIN(){
        var code = JSON.stringify(cbotClsObj);
        
        if ( code == "{}" ){
            alert("No blocks provided!\nPlease make sure that you have place at least one non-empty CloudBOT clousures.");
            return;
        }
        
        if( code != "" ){
            var postToCGIBIN = new XMLHttpRequest();
            postToCGIBIN.open("POST", "http://banterbun.com/cloudbot", true);
            postToCGIBIN.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
            postToCGIBIN.onreadystatechange = function() {
                if(postToCGIBIN.readyState == 4 && postToCGIBIN.status == 200) {
                    //console.log(postToCGIBIN.responseText);
                    alert("Commands sent to the cloud!");
                    
                    // Rebuilt cbotClsOj on send
                    //for(blocks in workspace.topBlocks_){
                    //    if(blocks.type == "cbot_closure" && blocks.inputList[0].fieldRow[1] != undefined){
                    //        var botName = blocks.inputList[0].fieldRow[1].text_
                    //        var botId = blocks.id
                    //        var source = Blockly.Python['cbot_closure'](blocks)
                    //        cbotClsObj[botName] = {"statement": source, "id": botId}
                    //    }
                    //}
                }
            }            
            postToCGIBIN.send("batch="+code);
            return true;
        }
        return false;
    }
    function updateStatusWindow(){
        var getStatus = new XMLHttpRequest();
        getStatus.open("GET", "http://banterbun.com/cloudbot?machinename=batch");
        getStatus.onreadystatechange = function(){
            if(getStatus.readyState == 4 && getStatus.status == 200) {
                var jsonResult = JSON.parse(getStatus.responseText)
                if (jsonResult['cbot1']['leftsense'] == undefined) document.getElementById("ind1_left").innerHTML = "\u2573"
                else if (jsonResult['cbot1']['leftsense'] == 1) document.getElementById("ind1_left").innerHTML = "\u25A0"
                else if (jsonResult['cbot1']['leftsense'] == 0) document.getElementById("ind1_left").innerHTML = "\u25A1"
                if (jsonResult['cbot1']['centersense'] == undefined) document.getElementById("ind1_center").innerHTML = "\u2573"
                else if (jsonResult['cbot1']['centersense'] == 1) document.getElementById("ind1_center").innerHTML = "\u25A0"
                else if (jsonResult['cbot1']['centersense'] == 0) document.getElementById("ind1_center").innerHTML = "\u25A1"
                if (jsonResult['cbot1']['rightsense'] == undefined) document.getElementById("ind1_right").innerHTML = "\u2573"
                else if (jsonResult['cbot1']['rightsense'] == 1) document.getElementById("ind1_right").innerHTML = "\u25A0"
                else if (jsonResult['cbot1']['rightsense'] == 0) document.getElementById("ind1_right").innerHTML = "\u25A1"
                if (jsonResult['cbot1']['distance'] == undefined) document.getElementById("ind1_distance").innerHTML = "-"
                else document.getElementById("ind1_distance").innerHTML = jsonResult['cbot1']['distance']
                if (jsonResult['cbot1']['temperature'] == undefined) document.getElementById("ind1_temp").innerHTML = "-"
                else document.getElementById("ind1_temp").innerHTML = jsonResult['cbot1']['temperature']

                if (jsonResult['cbot2']['leftsense'] == undefined) document.getElementById("ind2_left").innerHTML = "\u2573"
                else if (jsonResult['cbot2']['leftsense'] == 1) document.getElementById("ind2_left").innerHTML = "\u25A0"
                else if (jsonResult['cbot2']['leftsense'] == 0) document.getElementById("ind2_left").innerHTML = "\u25A1"
                if (jsonResult['cbot2']['centersense'] == undefined) document.getElementById("ind2_center").innerHTML = "\u2573"
                else if (jsonResult['cbot2']['centersense'] == 1) document.getElementById("ind2_center").innerHTML = "\u25A0"
                else if (jsonResult['cbot2']['centersense'] == 0) document.getElementById("ind2_center").innerHTML = "\u25A1"
                if (jsonResult['cbot2']['rightsense'] == undefined) document.getElementById("ind2_right").innerHTML = "\u2573"
                else if (jsonResult['cbot2']['rightsense'] == 1) document.getElementById("ind2_right").innerHTML = "\u25A0"
                else if (jsonResult['cbot2']['rightsense'] == 0) document.getElementById("ind2_right").innerHTML = "\u25A1"
                if (jsonResult['cbot2']['distance'] == undefined) document.getElementById("ind2_distance").innerHTML = "-"
                else document.getElementById("ind2_distance").innerHTML = jsonResult['cbot2']['distance']
                if (jsonResult['cbot2']['temperature'] == undefined) document.getElementById("ind2_temp").innerHTML = "-"
                else document.getElementById("ind2_temp").innerHTML = jsonResult['cbot2']['temperature']

                if (jsonResult['cbot3']['leftsense'] == undefined) document.getElementById("ind3_left").innerHTML = "\u2573"
                else if (jsonResult['cbot3']['leftsense'] == 1) document.getElementById("ind3_left").innerHTML = "\u25A0"
                else if (jsonResult['cbot3']['leftsense'] == 0) document.getElementById("ind3_left").innerHTML = "\u25A1"
                if (jsonResult['cbot3']['centersense'] == undefined) document.getElementById("ind3_center").innerHTML = "\u2573"
                else if (jsonResult['cbot3']['centersense'] == 1) document.getElementById("ind3_center").innerHTML = "\u25A0"
                else if (jsonResult['cbot3']['centersense'] == 0) document.getElementById("ind3_center").innerHTML = "\u25A1"
                if (jsonResult['cbot3']['rightsense'] == undefined) document.getElementById("ind3_right").innerHTML = "\u2573"
                else if (jsonResult['cbot3']['rightsense'] == 1) document.getElementById("ind3_right").innerHTML = "\u25A0"
                else if (jsonResult['cbot3']['rightsense'] == 0) document.getElementById("ind3_right").innerHTML = "\u25A1"
                if (jsonResult['cbot3']['distance'] == undefined) document.getElementById("ind3_distance").innerHTML = "-"
                else document.getElementById("ind3_distance").innerHTML = jsonResult['cbot3']['distance']
                if (jsonResult['cbot3']['temperature'] == undefined) document.getElementById("ind3_temp").innerHTML = "-"
                else document.getElementById("ind3_temp").innerHTML = jsonResult['cbot3']['temperature']

               updateStatusWindow();
            }
        }
        getStatus.send();
    }
    updateStatusWindow();
</script>
</body>
</html>
